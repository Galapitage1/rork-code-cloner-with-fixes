name: Direct FTP Deploy

on:
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy via FTP (Direct)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Export web app
        run: bun run export

      - name: Create deployment package
        run: |
          mkdir -p deployment-package
          cp -r dist/* deployment-package/
          cp -r public/Tracker deployment-package/Tracker

          if [ -f htaccess ]; then
            cp htaccess deployment-package/.htaccess
          fi

          mkdir -p deployment-package/data
          echo '[]' > deployment-package/data/storage.json

          cat > deployment-package/deploy-info.json <<EOF
          {
            "commit": "${GITHUB_SHA}",
            "runId": "${GITHUB_RUN_ID}",
            "runNumber": "${GITHUB_RUN_NUMBER}",
            "generatedAtUtc": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

      - name: Validate FTP secrets
        id: validate
        env:
          DEPLOY_FTP_HOST: ${{ secrets.DEPLOY_FTP_HOST }}
          DEPLOY_FTP_HOST_VAR: ${{ vars.DEPLOY_FTP_HOST }}
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          DEPLOY_FTP_USER: ${{ secrets.DEPLOY_FTP_USER }}
          DEPLOY_FTP_USER_VAR: ${{ vars.DEPLOY_FTP_USER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          DEPLOY_FTP_PASSWORD: ${{ secrets.DEPLOY_FTP_PASSWORD }}
          GITHUBDEPLOY: ${{ secrets.GITHUBDEPLOY }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
          DEPLOY_TARGET_PATH: ${{ secrets.DEPLOY_TARGET_PATH }}
          DEPLOY_TARGET_PATH_VAR: ${{ vars.DEPLOY_TARGET_PATH }}
          FTP_SERVER_DIR: ${{ secrets.FTP_SERVER_DIR }}
        run: |
          ftp_host="$DEPLOY_FTP_HOST"
          [ -z "$ftp_host" ] && ftp_host="$DEPLOY_FTP_HOST_VAR"
          [ -z "$ftp_host" ] && ftp_host="$FTP_SERVER"
          ftp_user="$DEPLOY_FTP_USER"
          [ -z "$ftp_user" ] && ftp_user="$DEPLOY_FTP_USER_VAR"
          [ -z "$ftp_user" ] && ftp_user="$FTP_USERNAME"
          target_path="$DEPLOY_TARGET_PATH"
          [ -z "$target_path" ] && target_path="$DEPLOY_TARGET_PATH_VAR"
          [ -z "$target_path" ] && target_path="$FTP_SERVER_DIR"

          ftp_password="$DEPLOY_FTP_PASSWORD"
          if [ -z "$ftp_password" ]; then
            ftp_password="$GITHUBDEPLOY"
          fi
          if [ -z "$ftp_password" ]; then
            ftp_password="$FTP_PASSWORD"
          fi

          ftp_host_set=no
          [ -n "$ftp_host" ] && ftp_host_set=yes
          ftp_user_set=no
          [ -n "$ftp_user" ] && ftp_user_set=yes
          ftp_host_var_set=no
          [ -n "$DEPLOY_FTP_HOST_VAR" ] && ftp_host_var_set=yes
          ftp_host_legacy_set=no
          [ -n "$FTP_SERVER" ] && ftp_host_legacy_set=yes
          ftp_user_var_set=no
          [ -n "$DEPLOY_FTP_USER_VAR" ] && ftp_user_var_set=yes
          ftp_user_legacy_set=no
          [ -n "$FTP_USERNAME" ] && ftp_user_legacy_set=yes
          ftp_password_set=no
          [ -n "$DEPLOY_FTP_PASSWORD" ] && ftp_password_set=yes
          githubdeploy_set=no
          [ -n "$GITHUBDEPLOY" ] && githubdeploy_set=yes
          ftp_password_legacy_set=no
          [ -n "$FTP_PASSWORD" ] && ftp_password_legacy_set=yes
          ftp_password_effective_set=no
          [ -n "$ftp_password" ] && ftp_password_effective_set=yes
          target_path_set=no
          [ -n "$target_path" ] && target_path_set=yes
          target_path_var_set=no
          [ -n "$DEPLOY_TARGET_PATH_VAR" ] && target_path_var_set=yes
          target_path_legacy_set=no
          [ -n "$FTP_SERVER_DIR" ] && target_path_legacy_set=yes

          echo "::notice::Secret status: DEPLOY_FTP_HOST=$ftp_host_set DEPLOY_FTP_HOST_VAR=$ftp_host_var_set FTP_SERVER=$ftp_host_legacy_set DEPLOY_FTP_USER=$ftp_user_set DEPLOY_FTP_USER_VAR=$ftp_user_var_set FTP_USERNAME=$ftp_user_legacy_set DEPLOY_FTP_PASSWORD=$ftp_password_set GITHUBDEPLOY=$githubdeploy_set FTP_PASSWORD=$ftp_password_legacy_set DEPLOY_TARGET_PATH=$target_path_set DEPLOY_TARGET_PATH_VAR=$target_path_var_set FTP_SERVER_DIR=$target_path_legacy_set FTP_PASSWORD_EFFECTIVE=$ftp_password_effective_set"

          missing=()
          [ -z "$ftp_host" ] && missing+=("DEPLOY_FTP_HOST (or Actions variable DEPLOY_FTP_HOST)")
          [ -z "$ftp_user" ] && missing+=("DEPLOY_FTP_USER (or Actions variable DEPLOY_FTP_USER)")
          [ -z "$ftp_password" ] && missing+=("DEPLOY_FTP_PASSWORD or GITHUBDEPLOY")
          [ -z "$target_path" ] && missing+=("DEPLOY_TARGET_PATH (or Actions variable DEPLOY_TARGET_PATH)")

          if [ "${#missing[@]}" -gt 0 ]; then
            echo "::error::Missing required FTP secret(s): ${missing[*]}"
            exit 1
          fi

          echo "FTP_HOST_EFFECTIVE=$ftp_host" >> "$GITHUB_ENV"
          echo "FTP_USER_EFFECTIVE=$ftp_user" >> "$GITHUB_ENV"
          echo "TARGET_PATH_EFFECTIVE=$target_path" >> "$GITHUB_ENV"
          echo "FTP_PASSWORD_EFFECTIVE=$ftp_password" >> "$GITHUB_ENV"

      - name: Upload deployment package via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ env.FTP_HOST_EFFECTIVE }}
          username: ${{ env.FTP_USER_EFFECTIVE }}
          password: ${{ env.FTP_PASSWORD_EFFECTIVE }}
          local-dir: deployment-package/
          server-dir: ${{ env.TARGET_PATH_EFFECTIVE }}/
          log-level: verbose

      - name: Optional HTTP verify deployed commit
        env:
          DEPLOY_VERIFY_URL: ${{ secrets.DEPLOY_VERIFY_URL }}
        run: |
          if [ -z "$DEPLOY_VERIFY_URL" ]; then
            echo "No DEPLOY_VERIFY_URL set. Skipping HTTP deploy verification."
            exit 0
          fi

          body="$(curl -fsSL --retry 3 --retry-delay 2 "$DEPLOY_VERIFY_URL")"
          if printf '%s' "$body" | grep -q "$GITHUB_SHA"; then
            echo "::notice::Verified deployed commit at $DEPLOY_VERIFY_URL"
          else
            echo "::error::Deployed commit verification failed at $DEPLOY_VERIFY_URL"
            exit 1
          fi
