name: Build and Deploy App

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Export web app
        run: bun run export

      - name: Create deployment package
        run: |
          mkdir -p deployment-package
          cp -r dist/* deployment-package/
          cp -r public/Tracker deployment-package/Tracker
          
          if [ -f htaccess ]; then
            cp htaccess deployment-package/.htaccess
          fi
          
          mkdir -p deployment-package/data
          echo '[]' > deployment-package/data/storage.json

          cat > deployment-package/deploy-info.json <<EOF
          {
            "commit": "${GITHUB_SHA}",
            "runId": "${GITHUB_RUN_ID}",
            "runNumber": "${GITHUB_RUN_NUMBER}",
            "generatedAtUtc": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

      - name: Upload deployment artifact
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: deployment-package/
          retention-days: 30

  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: build
    if: ${{ needs.build.result == 'success' }}

    steps:
      - name: Download deployment artifact
        uses: actions/download-artifact@v4
        with:
          name: deployment-package
          path: deployment-package/

      - name: Validate deploy secrets
        id: validate
        env:
          DEPLOY_SSH_HOST: ${{ secrets.DEPLOY_SSH_HOST }}
          DEPLOY_SSH_USER: ${{ secrets.DEPLOY_SSH_USER }}
          DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
          DEPLOY_FTP_HOST: ${{ secrets.DEPLOY_FTP_HOST }}
          DEPLOY_FTP_HOST_VAR: ${{ vars.DEPLOY_FTP_HOST }}
          DEPLOY_FTP_USER: ${{ secrets.DEPLOY_FTP_USER }}
          DEPLOY_FTP_USER_VAR: ${{ vars.DEPLOY_FTP_USER }}
          DEPLOY_FTP_PASSWORD: ${{ secrets.DEPLOY_FTP_PASSWORD }}
          GITHUBDEPLOY: ${{ secrets.GITHUBDEPLOY }}
          DEPLOY_TARGET_PATH: ${{ secrets.DEPLOY_TARGET_PATH }}
          DEPLOY_TARGET_PATH_VAR: ${{ vars.DEPLOY_TARGET_PATH }}
        run: |
          ftp_host="$DEPLOY_FTP_HOST"
          [ -z "$ftp_host" ] && ftp_host="$DEPLOY_FTP_HOST_VAR"
          ftp_user="$DEPLOY_FTP_USER"
          [ -z "$ftp_user" ] && ftp_user="$DEPLOY_FTP_USER_VAR"
          target_path="$DEPLOY_TARGET_PATH"
          [ -z "$target_path" ] && target_path="$DEPLOY_TARGET_PATH_VAR"

          ssh_enabled=true
          [ -z "$DEPLOY_SSH_HOST" ] && ssh_enabled=false
          [ -z "$DEPLOY_SSH_USER" ] && ssh_enabled=false
          [ -z "$DEPLOY_SSH_KEY" ] && ssh_enabled=false
          [ -z "$target_path" ] && ssh_enabled=false

          ftp_password="$DEPLOY_FTP_PASSWORD"
          if [ -z "$ftp_password" ]; then
            ftp_password="$GITHUBDEPLOY"
          fi

          ftp_enabled=true
          [ -z "$ftp_host" ] && ftp_enabled=false
          [ -z "$ftp_user" ] && ftp_enabled=false
          [ -z "$ftp_password" ] && ftp_enabled=false
          [ -z "$target_path" ] && ftp_enabled=false

          echo "ssh_enabled=$ssh_enabled" >> "$GITHUB_OUTPUT"
          echo "ftp_enabled=$ftp_enabled" >> "$GITHUB_OUTPUT"
          echo "ftp_host=$ftp_host" >> "$GITHUB_OUTPUT"
          echo "ftp_user=$ftp_user" >> "$GITHUB_OUTPUT"
          echo "target_path=$target_path" >> "$GITHUB_OUTPUT"

          ssh_host_set=no
          [ -n "$DEPLOY_SSH_HOST" ] && ssh_host_set=yes
          ssh_user_set=no
          [ -n "$DEPLOY_SSH_USER" ] && ssh_user_set=yes
          ssh_key_set=no
          [ -n "$DEPLOY_SSH_KEY" ] && ssh_key_set=yes

          ftp_host_set=no
          [ -n "$ftp_host" ] && ftp_host_set=yes
          ftp_user_set=no
          [ -n "$ftp_user" ] && ftp_user_set=yes
          ftp_host_var_set=no
          [ -n "$DEPLOY_FTP_HOST_VAR" ] && ftp_host_var_set=yes
          ftp_user_var_set=no
          [ -n "$DEPLOY_FTP_USER_VAR" ] && ftp_user_var_set=yes
          ftp_password_set=no
          [ -n "$DEPLOY_FTP_PASSWORD" ] && ftp_password_set=yes
          githubdeploy_set=no
          [ -n "$GITHUBDEPLOY" ] && githubdeploy_set=yes
          ftp_password_effective_set=no
          [ -n "$ftp_password" ] && ftp_password_effective_set=yes
          target_path_set=no
          [ -n "$target_path" ] && target_path_set=yes
          target_path_var_set=no
          [ -n "$DEPLOY_TARGET_PATH_VAR" ] && target_path_var_set=yes

          echo "::notice::Secret status: DEPLOY_SSH_HOST=$ssh_host_set DEPLOY_SSH_USER=$ssh_user_set DEPLOY_SSH_KEY=$ssh_key_set DEPLOY_FTP_HOST=$ftp_host_set DEPLOY_FTP_HOST_VAR=$ftp_host_var_set DEPLOY_FTP_USER=$ftp_user_set DEPLOY_FTP_USER_VAR=$ftp_user_var_set DEPLOY_FTP_PASSWORD=$ftp_password_set GITHUBDEPLOY=$githubdeploy_set DEPLOY_TARGET_PATH=$target_path_set DEPLOY_TARGET_PATH_VAR=$target_path_var_set FTP_PASSWORD_EFFECTIVE=$ftp_password_effective_set"

          if [ "$ssh_enabled" = "true" ]; then
            echo "::notice::Deploy mode: SSH/rsync"
          elif [ "$ftp_enabled" = "true" ]; then
            echo "::notice::Deploy mode: FTP"
          else
            echo "::error::Auto-deploy skipped. Configure either SSH secrets (DEPLOY_SSH_*) or FTP secrets (DEPLOY_FTP_*), plus DEPLOY_TARGET_PATH."
            exit 1
          fi

      - name: Prepare FTP credentials
        if: steps.validate.outputs.ssh_enabled != 'true' && steps.validate.outputs.ftp_enabled == 'true'
        env:
          DEPLOY_FTP_PASSWORD: ${{ secrets.DEPLOY_FTP_PASSWORD }}
          GITHUBDEPLOY: ${{ secrets.GITHUBDEPLOY }}
        run: |
          if [ -n "$DEPLOY_FTP_PASSWORD" ]; then
            echo "FTP_PASSWORD_EFFECTIVE=$DEPLOY_FTP_PASSWORD" >> "$GITHUB_ENV"
          else
            echo "FTP_PASSWORD_EFFECTIVE=$GITHUBDEPLOY" >> "$GITHUB_ENV"
          fi

      - name: Prepare SSH
        if: steps.validate.outputs.ssh_enabled == 'true'
        env:
          DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          printf '%s\n' "$DEPLOY_SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

      - name: Add server to known_hosts
        if: steps.validate.outputs.ssh_enabled == 'true'
        env:
          DEPLOY_SSH_HOST: ${{ secrets.DEPLOY_SSH_HOST }}
          DEPLOY_SSH_PORT: ${{ secrets.DEPLOY_SSH_PORT }}
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p "${DEPLOY_SSH_PORT:-22}" -H "$DEPLOY_SSH_HOST" >> ~/.ssh/known_hosts

      - name: Upload deployment package
        if: steps.validate.outputs.ssh_enabled == 'true'
        env:
          DEPLOY_SSH_HOST: ${{ secrets.DEPLOY_SSH_HOST }}
          DEPLOY_SSH_USER: ${{ secrets.DEPLOY_SSH_USER }}
          DEPLOY_SSH_PORT: ${{ secrets.DEPLOY_SSH_PORT }}
          DEPLOY_TARGET_PATH: ${{ secrets.DEPLOY_TARGET_PATH }}
        run: |
          ssh -p "${DEPLOY_SSH_PORT:-22}" "${DEPLOY_SSH_USER}@${DEPLOY_SSH_HOST}" "mkdir -p '${DEPLOY_TARGET_PATH}'"
          rsync -az --delete \
            -e "ssh -p ${DEPLOY_SSH_PORT:-22}" \
            deployment-package/ \
            "${DEPLOY_SSH_USER}@${DEPLOY_SSH_HOST}:${DEPLOY_TARGET_PATH%/}/"

      - name: Run post-deploy command (optional)
        if: steps.validate.outputs.ssh_enabled == 'true'
        env:
          DEPLOY_SSH_HOST: ${{ secrets.DEPLOY_SSH_HOST }}
          DEPLOY_SSH_USER: ${{ secrets.DEPLOY_SSH_USER }}
          DEPLOY_SSH_PORT: ${{ secrets.DEPLOY_SSH_PORT }}
          DEPLOY_POST_CMD: ${{ secrets.DEPLOY_POST_CMD }}
        run: |
          if [ -n "$DEPLOY_POST_CMD" ]; then
            ssh -p "${DEPLOY_SSH_PORT:-22}" "${DEPLOY_SSH_USER}@${DEPLOY_SSH_HOST}" "$DEPLOY_POST_CMD"
          else
            echo "No DEPLOY_POST_CMD set, skipping post-deploy command."
          fi

      - name: Upload deployment package via FTP
        if: steps.validate.outputs.ssh_enabled != 'true' && steps.validate.outputs.ftp_enabled == 'true'
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ steps.validate.outputs.ftp_host }}
          username: ${{ steps.validate.outputs.ftp_user }}
          password: ${{ env.FTP_PASSWORD_EFFECTIVE }}
          local-dir: deployment-package/
          server-dir: ${{ steps.validate.outputs.target_path }}/
          log-level: verbose

      - name: Optional HTTP verify deployed commit
        if: steps.validate.outputs.ssh_enabled == 'true' || steps.validate.outputs.ftp_enabled == 'true'
        env:
          DEPLOY_VERIFY_URL: ${{ secrets.DEPLOY_VERIFY_URL }}
        run: |
          if [ -z "$DEPLOY_VERIFY_URL" ]; then
            echo "No DEPLOY_VERIFY_URL set. Skipping HTTP deploy verification."
            exit 0
          fi

          body="$(curl -fsSL --retry 3 --retry-delay 2 "$DEPLOY_VERIFY_URL")"
          if printf '%s' "$body" | grep -q "$GITHUB_SHA"; then
            echo "::notice::Verified deployed commit at $DEPLOY_VERIFY_URL"
          else
            echo "::error::Deployed commit verification failed at $DEPLOY_VERIFY_URL"
            exit 1
          fi
