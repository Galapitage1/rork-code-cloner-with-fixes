name: Build and Deploy App

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Export web app
        run: bun run export

      - name: Create deployment package
        run: |
          mkdir -p deployment-package
          cp -r dist/* deployment-package/
          cp -r public/Tracker deployment-package/Tracker
          
          if [ -f htaccess ]; then
            cp htaccess deployment-package/.htaccess
          fi
          
          mkdir -p deployment-package/data
          echo '[]' > deployment-package/data/storage.json

      - name: Upload deployment artifact
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: deployment-package/
          retention-days: 30

  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: build
    if: ${{ needs.build.result == 'success' }}

    steps:
      - name: Download deployment artifact
        uses: actions/download-artifact@v4
        with:
          name: deployment-package
          path: deployment-package/

      - name: Validate deploy secrets
        id: validate
        env:
          DEPLOY_SSH_HOST: ${{ secrets.DEPLOY_SSH_HOST }}
          DEPLOY_SSH_USER: ${{ secrets.DEPLOY_SSH_USER }}
          DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
          DEPLOY_FTP_HOST: ${{ secrets.DEPLOY_FTP_HOST }}
          DEPLOY_FTP_USER: ${{ secrets.DEPLOY_FTP_USER }}
          DEPLOY_FTP_PASSWORD: ${{ secrets.DEPLOY_FTP_PASSWORD || secrets.GITHUBDEPLOY }}
          DEPLOY_TARGET_PATH: ${{ secrets.DEPLOY_TARGET_PATH }}
        run: |
          ssh_enabled=true
          [ -z "$DEPLOY_SSH_HOST" ] && ssh_enabled=false
          [ -z "$DEPLOY_SSH_USER" ] && ssh_enabled=false
          [ -z "$DEPLOY_SSH_KEY" ] && ssh_enabled=false
          [ -z "$DEPLOY_TARGET_PATH" ] && ssh_enabled=false

          ftp_enabled=true
          [ -z "$DEPLOY_FTP_HOST" ] && ftp_enabled=false
          [ -z "$DEPLOY_FTP_USER" ] && ftp_enabled=false
          [ -z "$DEPLOY_FTP_PASSWORD" ] && ftp_enabled=false
          [ -z "$DEPLOY_TARGET_PATH" ] && ftp_enabled=false

          echo "ssh_enabled=$ssh_enabled" >> "$GITHUB_OUTPUT"
          echo "ftp_enabled=$ftp_enabled" >> "$GITHUB_OUTPUT"

          if [ "$ssh_enabled" = "true" ]; then
            echo "::notice::Deploy mode: SSH/rsync"
          elif [ "$ftp_enabled" = "true" ]; then
            echo "::notice::Deploy mode: FTP"
          else
            echo "::warning::Auto-deploy skipped. Configure either SSH secrets (DEPLOY_SSH_*) or FTP secrets (DEPLOY_FTP_*), plus DEPLOY_TARGET_PATH."
          fi

      - name: Prepare SSH
        if: steps.validate.outputs.ssh_enabled == 'true'
        env:
          DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          printf '%s\n' "$DEPLOY_SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

      - name: Add server to known_hosts
        if: steps.validate.outputs.ssh_enabled == 'true'
        env:
          DEPLOY_SSH_HOST: ${{ secrets.DEPLOY_SSH_HOST }}
          DEPLOY_SSH_PORT: ${{ secrets.DEPLOY_SSH_PORT }}
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p "${DEPLOY_SSH_PORT:-22}" -H "$DEPLOY_SSH_HOST" >> ~/.ssh/known_hosts

      - name: Upload deployment package
        if: steps.validate.outputs.ssh_enabled == 'true'
        env:
          DEPLOY_SSH_HOST: ${{ secrets.DEPLOY_SSH_HOST }}
          DEPLOY_SSH_USER: ${{ secrets.DEPLOY_SSH_USER }}
          DEPLOY_SSH_PORT: ${{ secrets.DEPLOY_SSH_PORT }}
          DEPLOY_TARGET_PATH: ${{ secrets.DEPLOY_TARGET_PATH }}
        run: |
          ssh -p "${DEPLOY_SSH_PORT:-22}" "${DEPLOY_SSH_USER}@${DEPLOY_SSH_HOST}" "mkdir -p '${DEPLOY_TARGET_PATH}'"
          rsync -az --delete \
            -e "ssh -p ${DEPLOY_SSH_PORT:-22}" \
            deployment-package/ \
            "${DEPLOY_SSH_USER}@${DEPLOY_SSH_HOST}:${DEPLOY_TARGET_PATH%/}/"

      - name: Run post-deploy command (optional)
        if: steps.validate.outputs.ssh_enabled == 'true'
        env:
          DEPLOY_SSH_HOST: ${{ secrets.DEPLOY_SSH_HOST }}
          DEPLOY_SSH_USER: ${{ secrets.DEPLOY_SSH_USER }}
          DEPLOY_SSH_PORT: ${{ secrets.DEPLOY_SSH_PORT }}
          DEPLOY_POST_CMD: ${{ secrets.DEPLOY_POST_CMD }}
        run: |
          if [ -n "$DEPLOY_POST_CMD" ]; then
            ssh -p "${DEPLOY_SSH_PORT:-22}" "${DEPLOY_SSH_USER}@${DEPLOY_SSH_HOST}" "$DEPLOY_POST_CMD"
          else
            echo "No DEPLOY_POST_CMD set, skipping post-deploy command."
          fi

      - name: Upload deployment package via FTP
        if: steps.validate.outputs.ssh_enabled != 'true' && steps.validate.outputs.ftp_enabled == 'true'
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.DEPLOY_FTP_HOST }}
          username: ${{ secrets.DEPLOY_FTP_USER }}
          password: ${{ secrets.DEPLOY_FTP_PASSWORD || secrets.GITHUBDEPLOY }}
          local-dir: deployment-package/
          server-dir: ${{ secrets.DEPLOY_TARGET_PATH }}/
